<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kure-AI Realtime Explorer</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
        body { margin: 0; padding: 0; font-family: "Helvetica Neue", Arial, sans-serif; display: flex; height: 100vh; }
        #sidebar { width: 380px; background: #f8f9fa; padding: 20px; overflow-y: auto; z-index: 1000; display: flex; flex-direction: column; box-shadow: 2px 0 5px rgba(0,0,0,0.1); }
        #map { flex-grow: 1; height: 100%; cursor: crosshair; }
        .control-group { margin-bottom: 15px; border-bottom: 1px solid #ddd; padding-bottom: 15px; }
        label { display: block; font-weight: bold; margin-bottom: 5px; color: #555; font-size: 0.9em; }
        input { width: 100%; padding: 8px; box-sizing: border-box; border: 1px solid #ccc; border-radius: 4px; margin-bottom: 5px; }
        button { width: 100%; padding: 12px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 1em; transition: 0.2s; }
        button:hover { background: #0056b3; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        #log-area { font-size: 0.8em; color: #666; margin-bottom: 10px; height: 60px; overflow-y: scroll; background: #eee; padding: 5px; border-radius: 4px;}
        #ai-response { flex-grow: 1; padding: 10px; background: white; border: 1px solid #ddd; border-radius: 4px; overflow-y: auto; }
        
        /* ã‚¢ã‚¤ã‚³ãƒ³è£…é£¾ */
        .custom-icon { display: flex; justify-content: center; align-items: center; border-radius: 50%; color: white; font-size: 14px; box-shadow: 0 3px 5px rgba(0,0,0,0.3); border: 2px solid white; }
        .bg-osm { background: #FF4500; }
        .bg-kure { background: #0000FF; }
        .bg-steps { background: #00BFFF; }
        .bg-view { background: #32CD32; }
    </style>
</head>
<body>

    <div id="sidebar">
        <h2>ğŸ“¡ Kure-AI Realtime API</h2>
        
        <div class="control-group">
            <label>1. Gemini APIã‚­ãƒ¼ (å¿…é ˆ)</label>
            <input type="password" id="gemini-key" placeholder="AI Studioã§å–å¾—ã—ãŸã‚­ãƒ¼ã‚’å…¥åŠ›">
        </div>

        <div class="control-group">
            <label>2. å‘‰å¸‚ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆID (ã‚«ã‚¿ãƒ­ã‚°å‚ç…§)</label>
            <input type="text" id="placeholder" placeholder="ä¾‹: ãƒ‡ã‚¶ã‚¤ãƒ³ãƒãƒ³ãƒ›ãƒ¼ãƒ«ã®ID" value="">
            <input type="text" id="tourist" placeholder="ä¾‹: è¦³å…‰æ–½è¨­ã®ID" value="">
            <input type="text" id="id-culture" placeholder="æ–‡åŒ–è²¡ãƒ»æ­´å²ã®ID" value="">
            <input type="text" id="id-shelter" placeholder="é¿é›£æ‰€ã®ID (çµ¶æ™¯æ¢ã—ç”¨)" value="">
        </div>

        <div class="control-group">
            <label>3. ä»Šã®æ°—åˆ†ãƒ»ãƒ†ãƒ¼ãƒ</label>
            <input type="text" id="user-mood" placeholder="ä¾‹: é™ã‹ã§è½ã¡ç€ã‘ã‚‹å ´æ‰€ã€å·¥å ´èŒãˆã€ã‚µã‚¤ãƒãƒ¼ãƒ‘ãƒ³ã‚¯ãªå†™çœŸæ—…">
        </div>

        <div id="log-area">ã‚·ã‚¹ãƒ†ãƒ ãƒ­ã‚°: å¾…æ©Ÿä¸­...</div>

        <button id="btn-search" onclick="askAI()" disabled>AIã«ãƒ—ãƒ©ãƒ³ã‚’èã</button>
        <div id="ai-response">åœ°å›³ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨æ¢ç´¢ã‚’é–‹å§‹ã—ã¾ã™ã€‚</div>
    </div>

    <div id="map"></div>

    <script>
        // ==========================================
        // â˜…ã“ã“ã«APIã‚­ãƒ¼ã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„â˜…
        // ==========================================
        const WEATHER_API_KEY = "f5ced26dbed1c3f5d9ca115851dd4cce";
        const KURE_API_KEY    = "a2620ef7-164e-467c-85c6-a51ca43f1fe5";
        // ==========================================

        // --- ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•° ---
        let map;
        let markersLayer = L.layerGroup();
        let currentLat, currentLon;
        let gatheredSpots = [];
        let weatherDescription = "";

        // --- 1. åˆæœŸåŒ– ---
        window.onload = function() {
            map = L.map('map').setView([34.248, 132.565], 14);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: 'Â© OpenStreetMap contributors'
            }).addTo(map);
            markersLayer.addTo(map);

            map.on('click', async function(e) {
                await startExploration(e.latlng.lat, e.latlng.lng);
            });
        };

        function log(msg) {
            const el = document.getElementById('log-area');
            el.innerHTML += `<div>${msg}</div>`;
            el.scrollTop = el.scrollHeight;
        }

        // --- 2. æ¢ç´¢é–‹å§‹ ---
        async function startExploration(lat, lon) {
            currentLat = lat; currentLon = lon;
            gatheredSpots = [];
            markersLayer.clearLayers();
            
            L.marker([lat, lon]).addTo(markersLayer).bindPopup("ç¾åœ¨åœ°").openPopup();
            document.getElementById('btn-search').disabled = true;
            document.getElementById('ai-response').innerHTML = "ãƒ‡ãƒ¼ã‚¿åé›†ä¸­...";
            document.getElementById('log-area').innerHTML = ""; 

            log(`ğŸ“ æ¢ç´¢é–‹å§‹: ${lat.toFixed(4)}, ${lon.toFixed(4)}`);

            const dId1 = document.getElementById('dataset-id-1').value;
            const dId2 = document.getElementById('dataset-id-2').value;

            // APIãƒªã‚¯ã‚¨ã‚¹ãƒˆä¸¦è¡Œå®Ÿè¡Œ
            const promises = [];
            
            // A. å¤©æ°— (å®šæ•°ã‚’ä½¿ç”¨)
            promises.push(fetchWeather(lat, lon));
            
            // B. OSM
            promises.push(fetchOverpass(lat, lon));

            // C. å‘‰å¸‚å…¬å¼ (å®šæ•°ã‚’ä½¿ç”¨)
            if(dId1) promises.push(fetchKureData(dId1, "å…¬å¼ãƒ‡ãƒ¼ã‚¿1"));
            if(dId2) promises.push(fetchKureData(dId2, "å…¬å¼ãƒ‡ãƒ¼ã‚¿2"));

            await Promise.all(promises);

            log(`âœ… å®Œäº†ã€‚${gatheredSpots.length} ä»¶ã®ã‚¹ãƒãƒƒãƒˆç™ºè¦‹ã€‚`);
            document.getElementById('btn-search').disabled = false;
            document.getElementById('ai-response').innerHTML = `ãƒ‡ãƒ¼ã‚¿åé›†å®Œäº†ï¼<br>ç¾åœ¨ã®å¤©æ°—: ${weatherDescription}<br>ç™ºè¦‹ã‚¹ãƒãƒƒãƒˆ: ${gatheredSpots.length}ä»¶<br>ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦AIã«èã„ã¦ãã ã•ã„ã€‚`;
        }

        // --- API A: å¤©æ°— (OpenWeather) ---
        async function fetchWeather(lat, lon) {
            if (WEATHER_API_KEY.includes("è²¼ã‚Šä»˜ã‘")) {
                log("âš ï¸ OpenWeatherã‚­ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“"); return;
            }
            try {
                const url = `https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lon}&appid=${WEATHER_API_KEY}&lang=ja&units=metric`;
                const res = await fetch(url);
                const data = await res.json();
                weatherDescription = `${data.weather[0].description} (æ°—æ¸©:${data.main.temp}â„ƒ)`;
                log(`ğŸŒ¤ å¤©æ°—: ${weatherDescription}`);
            } catch(e) {
                log(`âŒ å¤©æ°—ã‚¨ãƒ©ãƒ¼: ${e.message}`);
                weatherDescription = "å–å¾—å¤±æ•—";
            }
        }

        // --- API B: OSM (Overpass) ---
        async function fetchOverpass(lat, lon) {
            log("ğŸŒ OSMæ¤œç´¢ä¸­...");
            const query = `
                [out:json][timeout:25];
                (
                  way["highway"="steps"](around:1000, ${lat}, ${lon});
                  node["amenity"="place_of_worship"](around:1000, ${lat}, ${lon});
                  node["tourism"="viewpoint"](around:1000, ${lat}, ${lon});
                  node["man_made"="torii"](around:1000, ${lat}, ${lon});
                  node["highway"="street_lamp"](around:1000, ${lat}, ${lon});
                );
                out center;
            `;
            const url = "https://overpass-api.de/api/interpreter?data=" + encodeURIComponent(query);

            try {
                const res = await fetch(url);
                const data = await res.json();
                data.elements.forEach(el => {
                    const elLat = el.lat || el.center.lat;
                    const elLon = el.lon || el.center.lon;
                    let type = "ãã®ä»–";
                    let bg = "bg-osm";

                    if(el.tags.highway === "steps") { type = "éšæ®µ"; bg = "bg-steps"; }
                    else if(el.tags.tourism === "viewpoint") { type = "çµ¶æ™¯"; bg = "bg-view"; }
                    else if(el.tags.amenity === "place_of_worship") { type = "ç¥ç¤¾ä»é–£"; bg = "bg-osm"; }

                    addSpotToMap(elLat, elLon, type, el.tags.name || "åç§°ãªã—", "OpenStreetMap", bg);
                });
                log(`ğŸŒ OSM: ${data.elements.length}ä»¶`);
            } catch(e) { log(`âŒ OSMã‚¨ãƒ©ãƒ¼: ${e.message}`); }
        }

        // --- API C: å‘‰å¸‚ (Data Platform Kure) ä¿®æ­£ç‰ˆ ---
        async function fetchKureData(endpointId, label) {
            if (KURE_API_KEY.includes("è²¼ã‚Šä»˜ã‘")) {
                log("âš ï¸ å‘‰å¸‚APIã‚­ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“"); return;
            }
            log(`âš“ï¸ å‘‰ãƒ‡ãƒ¼ã‚¿(${label})å–å¾—ä¸­...`);
    
            // â˜…ä¿®æ­£1: ç”»åƒã«åŸºã¥ã„ã¦URLæ§‹é€ ã‚’å¤‰æ›´ã—ã¾ã—ãŸ
            const url = `https://api.expolis.cloud/opendata/t/kure/v1/${endpointId}`;
    
            try {
                const res = await fetch(url, {
                    headers: { 
                        "Authorization": `Bearer ${KURE_API_KEY}`,
                        "Content-Type": "application/json"
                    }
                });
                if(!res.ok) throw new Error(`Status ${res.status}`);
                const data = await res.json();

                let count = 0;
                data.forEach(item => {
                    // â˜…ä¿®æ­£2: ç”»åƒã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã«åˆã‚ã›ã¦ 'long' ã‚‚ãƒã‚§ãƒƒã‚¯ã™ã‚‹ã‚ˆã†ã«è¿½åŠ 
                    const iLat = item.latitude || item.lat || item.Lat;
                    const iLon = item.longitude || item.lon || item.Lon || item.long; 
                    const iName = item.name || item.title || item.åç§° || "åç§°ä¸æ˜";
            
                    if(iLat && iLon) {
                        const dist = Math.sqrt(Math.pow(currentLat - iLat, 2) + Math.pow(currentLon - iLon, 2));
                        if(dist < 0.015) { // 1.5kmåœå†…
                            addSpotToMap(iLat, iLon, label, iName, "KureOfficial", "bg-kure");
                            count++;
                        }
                    }
                });
                log(`âš“ï¸ ${label}: ${count}ä»¶(å‘¨è¾º)`);
            } catch(e) { log(`âŒ å‘‰APIã‚¨ãƒ©ãƒ¼: ${e.message}`); }
        }

        function addSpotToMap(lat, lon, type, name, source, bgClass) {
            gatheredSpots.push({ lat, lon, type, name, source });
            const icon = L.divIcon({
                className: '',
                html: `<div class="custom-icon ${bgClass}" style="width:20px; height:20px;"></div>`,
                iconSize: [20, 20]
            });
            L.marker([lat, lon], {icon: icon})
             .bindPopup(`<b>${name}</b><br>${type}<br><small>${source}</small>`)
             .addTo(markersLayer);
        }

        // --- 3. AIã«èã ---
        async function askAI() {
            const geminiKey = document.getElementById('gemini-key').value;
            const mood = document.getElementById('user-mood').value;
            
            if(!geminiKey) { alert("Gemini APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); return; }
            if(gatheredSpots.length === 0) { alert("å‘¨è¾ºã«ã‚¹ãƒãƒƒãƒˆãŒã‚ã‚Šã¾ã›ã‚“"); return; }

            document.getElementById('ai-response').innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> AIãŒãƒ«ãƒ¼ãƒˆã‚’ç”Ÿæˆä¸­...';

            const spotsList = gatheredSpots
                .sort(() => 0.5 - Math.random())
                .slice(0, 30)
                .map(s => `- [${s.source}] ${s.type}: ${s.name}`)
                .join("\n");

            const prompt = `
ã‚ãªãŸã¯å‘‰å¸‚ã®è¦³å…‰ã‚¬ã‚¤ãƒ‰ã§ã™ã€‚ä»¥ä¸‹ã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰æ•£æ­©ãƒ—ãƒ©ãƒ³ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚
ã€çŠ¶æ³ã€‘å¤©æ°—: ${weatherDescription} / æ°—åˆ†: ${mood}
ã€å‘¨è¾ºã‚¹ãƒãƒƒãƒˆã€‘
${spotsList}
ã€æŒ‡ä»¤ã€‘
1. å¤©æ°—ã«åˆã†ã€Œæ•£æ­©ãƒ†ãƒ¼ãƒã€
2. [KureOfficial]ã‚’å«ã‚€3ã¤ã®ãƒ«ãƒ¼ãƒˆææ¡ˆ
3. æƒ…ç·’çš„ãªè§£èª¬
`;

            try {
                const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${geminiKey}`;
                const res = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });
                const result = await res.json();
                const text = result.candidates[0].content.parts[0].text;
                document.getElementById('ai-response').innerHTML = marked.parse(text);
            } catch(e) {
                document.getElementById('ai-response').innerHTML = "AIã‚¨ãƒ©ãƒ¼: " + e.message;
            }
        }
    </script>
</body>
</html>